# Общий шаблон (anchor) для всех сервисов.
# Это помогает не копипастить одно и то же (build/volumes/working_dir/env) 4 раза.
x-base: &base
  # Собираем образ из Dockerfile в текущей папке (.)
  build: .

  # Монтируем текущую папку проекта внутрь контейнера.
  volumes:
    - .:/usr/workspace

  # Рабочая папка внутри контейнера (отсюда запускаются команды)
  working_dir: /usr/workspace

  # Переменные окружения, которые нужны тестам.
  environment:
    HOST: ${HOST:?HOST is required}
    # DummyAPI требует заголовок app-id (APP_ID)
    APP_ID: ${API_TOKEN:?API_TOKEN is required}
    API_TOKEN: ${API_TOKEN:?API_TOKEN is required}

services:
  # Запускает ВСЕ наборы: smoke (crud) + regression + negative
  all:
    <<: *base
    command: >
      sh -c '
        rm -rf allure-results;
        mkdir -p allure-results;

        pytest -sv \
          tests/users/test_users_crud.py \
          tests/posts/test_post_crud.py \
          tests/comments/test_comments_crud.py \
          tests/users/test_users_regression.py \
          tests/posts/test_post_regression.py \
          tests/comments/test_comments_regression.py \
          tests/users/test_users_negative.py \
          tests/posts/test_post_negative.py \
          tests/comments/test_comments_negative.py \
          --alluredir=allure-results;

        exit $?
      '

  # Smoke: только CRUD-набор (быстрый прогон)
  smoke:
    <<: *base
    command: >
      sh -c '
        rm -rf allure-results;
        mkdir -p allure-results;

        pytest -sv \
          tests/users/test_users_crud.py \
          tests/posts/test_post_crud.py \
          tests/comments/test_comments_crud.py \
          --alluredir=allure-results;

        exit $?
      '

  # Regression: регрессионные тесты (средний по времени прогон)
  regression:
    <<: *base
    command: >
      sh -c '
        rm -rf allure-results;
        mkdir -p allure-results;

        pytest -sv \
          tests/users/test_users_regression.py \
          tests/posts/test_post_regression.py \
          tests/comments/test_comments_regression.py \
          --alluredir=allure-results;

        exit $?
      '
  

  # Negative: негативные тесты (проверка ошибок/валидаций)
  negative:
    <<: *base
    command: >
      sh -c '
        rm -rf allure-results;
        mkdir -p allure-results;

        pytest -sv \
          tests/users/test_users_negative.py \
          tests/posts/test_post_negative.py \
          tests/comments/test_comments_negative.py \
          --alluredir=allure-results;

        exit $?
      '














## Общий шаблон (anchor) для всех сервисов.
## Это помогает не копипастить одно и то же (build/volumes/working_dir/env) 4 раза.
#x-base: &base
#  # Собираем образ из Dockerfile в текущей папке (.)
#  build: .
#
#  # Монтируем текущую папку проекта внутрь контейнера.
#  volumes:
#    - .:/usr/workspace
#
#  # Рабочая папка внутри контейнера (отсюда запускаются команды)
#  working_dir: /usr/workspace
#
#  # Переменные окружения, которые нужны тестам.
#  environment:
#    HOST: ${HOST:?HOST is required}
#    # DummyAPI требует заголовок app-id (APP_ID)
#    APP_ID: ${API_TOKEN:?API_TOKEN is required}
#    API_TOKEN: ${API_TOKEN:?API_TOKEN is required}
#
#services:
#  # Запускает ВСЕ наборы: smoke (crud) + regression + negative
#  all:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_crud.py \
#          tests/posts/test_post_crud.py \
#          tests/comments/test_comments_crud.py \
#          tests/users/test_users_regression.py \
#          tests/posts/test_post_regression.py \
#          tests/comments/test_comments_regression.py \
#          tests/users/test_users_negative.py \
#          tests/posts/test_post_negative.py \
#          tests/comments/test_comments_negative.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
#
#  # Smoke: только CRUD-набор (быстрый прогон)
#  smoke:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_crud.py \
#          tests/posts/test_post_crud.py \
#          tests/comments/test_comments_crud.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
#
#  # Regression: регрессионные тесты (средний по времени прогон)
#  regression:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_regression.py \
#          tests/posts/test_post_regression.py \
#          tests/comments/test_comments_regression.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
#
#  # Negative: негативные тесты (проверка ошибок/валидаций)
#  negative:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_negative.py \
#          tests/posts/test_post_negative.py \
#          tests/comments/test_comments_negative.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
