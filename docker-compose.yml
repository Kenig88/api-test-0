# docker-compose.yml
# Этот файл описывает сервисы (контейнеры), которые запускают разные наборы pytest-тестов.
# Контейнеры НЕ генерируют HTML Allure-отчёт — они только создают "сырые" результаты в allure-results/.
# HTML-отчёт обычно строится уже в CI (например, GitHub Actions) из папки allure-results/.

# --------------------------------------------
# Общий шаблон (anchor) для всех сервисов
# --------------------------------------------
# x-base — это "шаблон" настроек (не сервис).
# Его нельзя запустить напрямую.
# Он нужен, чтобы не копировать одинаковые настройки в all/smoke/regression/negative.
x-base: &base

  # build: . — собрать Docker-образ из Dockerfile в корне проекта
  build: .

  # Монтируем текущую папку проекта внутрь контейнера:
  # - внутри контейнера код доступен как /usr/workspace
  # - папка allure-results/, созданная в контейнере, появится и на хосте (в репозитории)
  volumes:
    - .:/usr/workspace

  # Рабочая директория для команд внутри контейнера
  working_dir: /usr/workspace

  # Переменные окружения, которые нужны тестам.
  # Если переменная не задана — docker compose сразу завершится с понятной ошибкой.
  environment:
    # HOST — базовый URL тестируемого API
    HOST: ${HOST:?HOST is required}

    # DummyAPI требует заголовок app-id.
    # В проекте APP_ID берём из API_TOKEN (как ты настроила).
    APP_ID: ${API_TOKEN:?API_TOKEN is required}

    # API_TOKEN — токен/ключ доступа (в DummyAPI он же app-id)
    API_TOKEN: ${API_TOKEN:?API_TOKEN is required}

# --------------------------------------------
# Сервисы (их можно запускать)
# --------------------------------------------
services:

  # all — запускает все тесты
  all:
    <<: *base
    # --alluredir=...      куда складывать "сырые" результаты Allure
    # --clean-alluredir    очистить папку перед запуском (чтобы отчёт не смешивался со старым)
    command: ["pytest", "-sv", "--alluredir=allure-results", "--clean-alluredir"]

  # smoke — быстрый прогон (маркер smoke)
  smoke:
    <<: *base
    command: ["pytest", "-sv", "-m", "smoke", "--alluredir=allure-results", "--clean-alluredir"]

  # regression — полный регресс (маркер regression)
  regression:
    <<: *base
    command: ["pytest", "-sv", "-m", "regression", "--alluredir=allure-results", "--clean-alluredir"]

  # negative — негативные сценарии (маркер negative)
  negative:
    <<: *base
    command: ["pytest", "-sv", "-m", "negative", "--alluredir=allure-results", "--clean-alluredir"]