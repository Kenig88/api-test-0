# docker-compose.yml
# Здесь мы описываем сервисы (контейнеры), которые запускают разные наборы тестов.
# ВАЖНО: контейнеры НЕ генерируют HTML Allure-отчёт.
# Они только запускают pytest и создают "сырые" результаты в папку allure-results/.
# А уже GitHub Actions по этим результатам строит HTML + историю и публикует на Pages.

# --------------------------------------------
# Общий шаблон (anchor) для всех сервисов
# --------------------------------------------
# x-base — это "шаблон" (не сервис), его нельзя запустить напрямую.
# Он нужен, чтобы не копипастить одинаковые настройки в all/smoke/regression/negative.
x-base: &base

  # build: . — собрать Docker-образ из Dockerfile в текущей папке проекта
  build: .

  # volumes:
  #  - .:/usr/workspace
  #
  # Монтируем текущую папку проекта (на хосте) внутрь контейнера.
  # Это ключевая вещь:
  # - контейнер видит твой код/тесты как /usr/workspace
  # - все файлы, которые контейнер создаст в /usr/workspace, появятся на хосте тоже
  #
  # Поэтому allure-results/ создаётся "в репозитории" (на раннере/локально),
  # хотя пишет её контейнер.
  volumes:
    - .:/usr/workspace

  # working_dir — папка, из которой выполняются команды внутри контейнера.
  working_dir: /usr/workspace

  # environment — переменные окружения, которые нужны тестам.
  # Мы берём их с хоста/CI. Если их нет — docker compose сразу упадёт с понятной ошибкой.
  environment:
    # HOST — базовый URL/хост API, с которым работают тесты
    HOST: ${HOST:?HOST is required}

    # DummyAPI требует заголовок app-id (APP_ID).
    # Мы используем значение API_TOKEN как APP_ID (как ты и настроил).
    APP_ID: ${API_TOKEN:?API_TOKEN is required}

    # API_TOKEN — токен (или app-id), который нужен тестам для запросов
    API_TOKEN: ${API_TOKEN:?API_TOKEN is required}


# --------------------------------------------
# Сервисы (то, что реально можно запускать)
# --------------------------------------------
services:

  # ------------------------------------------------------------
  # all — запускает сразу ВСЕ наборы тестов одним прогоном pytest
  # ------------------------------------------------------------
  all:
    # <<: *base — "влить" все настройки из шаблона x-base
    <<: *base

    # command выполняется внутри контейнера.
    # Мы используем sh -c '...' чтобы выполнить несколько команд подряд.
    command: >
      sh -c '
        # Чистим результаты предыдущего прогона.
        # Это важно, чтобы новый отчёт не смешивался со старым.
        rm -rf allure-results;
        mkdir -p allure-results;

        # Запускаем pytest и перечисляем конкретные файлы тестов.
        # -s: показывать print/logs в консоли
        # -v: более подробный вывод
        # --alluredir=allure-results: сохраняем "сырые" результаты Allure в папку allure-results
        pytest -sv \
          tests/users/test_users_crud.py \
          tests/posts/test_post_crud.py \
          tests/comments/test_comments_crud.py \
          tests/users/test_users_regression.py \
          tests/posts/test_post_regression.py \
          tests/comments/test_comments_regression.py \
          tests/users/test_users_negative.py \
          tests/posts/test_post_negative.py \
          tests/comments/test_comments_negative.py \
          --alluredir=allure-results;

        # Возвращаем exit code pytest наружу.
        # Если тесты упали, GitHub Actions увидит ошибку (но дальше всё равно построит отчёт,
        # потому что в workflow на шагах Allure стоит if: always()).
        exit $?
      '

  # ------------------------------------------------------------
  # smoke — быстрый прогон: только CRUD-набор
  # ------------------------------------------------------------
  smoke:
    <<: *base
    command: >
      sh -c '
        rm -rf allure-results;
        mkdir -p allure-results;

        pytest -sv \
          tests/users/test_users_crud.py \
          tests/posts/test_post_crud.py \
          tests/comments/test_comments_crud.py \
          --alluredir=allure-results;

        exit $?
      '

  # ------------------------------------------------------------
  # regression — регрессионные тесты (дольше, чем smoke)
  # ------------------------------------------------------------
  regression:
    <<: *base
    command: >
      sh -c '
        rm -rf allure-results;
        mkdir -p allure-results;

        pytest -sv \
          tests/users/test_users_regression.py \
          tests/posts/test_post_regression.py \
          tests/comments/test_comments_regression.py \
          --alluredir=allure-results;

        exit $?
      '

  # ------------------------------------------------------------
  # negative — негативные тесты (валидации/ошибки/невалидные данные)
  # ------------------------------------------------------------
  negative:
    <<: *base
    command: >
      sh -c '
        rm -rf allure-results;
        mkdir -p allure-results;

        pytest -sv \
          tests/users/test_users_negative.py \
          tests/posts/test_post_negative.py \
          tests/comments/test_comments_negative.py \
          --alluredir=allure-results;

        exit $?
      '














## Общий шаблон (anchor) для всех сервисов.
## Это помогает не копипастить одно и то же (build/volumes/working_dir/env) 4 раза.
#x-base: &base
#  # Собираем образ из Dockerfile в текущей папке (.)
#  build: .
#
#  # Монтируем текущую папку проекта внутрь контейнера.
#  volumes:
#    - .:/usr/workspace
#
#  # Рабочая папка внутри контейнера (отсюда запускаются команды)
#  working_dir: /usr/workspace
#
#  # Переменные окружения, которые нужны тестам.
#  environment:
#    HOST: ${HOST:?HOST is required}
#    # DummyAPI требует заголовок app-id (APP_ID)
#    APP_ID: ${API_TOKEN:?API_TOKEN is required}
#    API_TOKEN: ${API_TOKEN:?API_TOKEN is required}
#
#services:
#  # Запускает ВСЕ наборы: smoke (crud) + regression + negative
#  all:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_crud.py \
#          tests/posts/test_post_crud.py \
#          tests/comments/test_comments_crud.py \
#          tests/users/test_users_regression.py \
#          tests/posts/test_post_regression.py \
#          tests/comments/test_comments_regression.py \
#          tests/users/test_users_negative.py \
#          tests/posts/test_post_negative.py \
#          tests/comments/test_comments_negative.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
#
#  # Smoke: только CRUD-набор (быстрый прогон)
#  smoke:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_crud.py \
#          tests/posts/test_post_crud.py \
#          tests/comments/test_comments_crud.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
#
#  # Regression: регрессионные тесты (средний по времени прогон)
#  regression:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_regression.py \
#          tests/posts/test_post_regression.py \
#          tests/comments/test_comments_regression.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
#
#  # Negative: негативные тесты (проверка ошибок/валидаций)
#  negative:
#    <<: *base
#    command: >
#      sh -c '
#        set +e
#        rm -rf allure-results;
#        mkdir -p allure-results;
#
#        pytest -sv \
#          tests/users/test_users_negative.py \
#          tests/posts/test_post_negative.py \
#          tests/comments/test_comments_negative.py \
#          --alluredir=allure-results;
#        TEST_EXIT=$?;
#
#        if [ -d allure-report/history ]; then
#          mkdir -p allure-results/history;
#          cp -r allure-report/history/* allure-results/history/ || true;
#        fi;
#
#        allure generate allure-results -o allure-report --clean || true;
#        touch allure-report/.nojekyll || true;
#
#        exit $TEST_EXIT
#      '
